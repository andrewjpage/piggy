#!/bin/bash

usage()
{
cat << EOF

igry

 -i input directory (default - current directory)
 -o output directory (default - current directory/igry_out)
 -t threads (default 1)
 -r roary output directory
 -h help

EOF
}

if [[ ! $@ =~ ^\-.+ ]]
then
	usage
	exit
fi

in_dir=$(pwd)
out_dir="$in_dir/igry_out"
threads=1

while getopts "i: o: t: r: h" opt; do
 	case "$opt" in
		i) in_dir=$OPTARG;;
		o) out_dir=$OPTARG;;
		t) threads=$OPTARG;;
		r) roary_dir=$OPTARG;;
		h) usage;exit;;
	esac
done

if [ 1 -eq 0 ]; then

if [ ! -d "$in_dir" ]
then
	printf "Input folder doesn't exist.\n"
fi

if [ ! -d "$out_dir" ]
then
	mkdir "$out_dir"
	
	if [ -d "$out_dir" ]
	then
		printf "Created output folder $out_dir\n"
	fi
fi

file_array=("$in_dir/*.gff")

count=0
for file in $file_array
do
	isolate=("${file##*/}")
	isolate=("${isolate%%.*}")
	
	isolate_array[count]=$isolate
	
	count=$((count + 1))
done

isolate_count=${#isolate_array[@]}

printf "$isolate_count isolates found.\n"

printf "" >  "$out_dir/isolates.txt"

for i in ${isolate_array[@]}
do
	printf "%s\n" $i >> "$out_dir/isolates.txt"
done

if [ -f "$out_dir/output_fasta.fasta" ]
then
	rm "$out_dir/output_fasta.fasta"
fi

if [ ! -d "$out_dir/isolate_intergenic_files" ]
then
	mkdir "$out_dir/isolate_intergenic_files"
fi

if [ ! -d "$out_dir/coordinate_files" ]
then
	mkdir "$out_dir/coordinate_files"
fi

for isolate in ${isolate_array[@]}
do
	gff_modifier.pl "$isolate" "$in_dir" "$out_dir"
	
	gene_intergenic_coordinate_extracter.pl "$isolate" "$in_dir" "$out_dir"
	
	intergenic_sequence_extracter.pl "$isolate" "$in_dir" "$out_dir"
done

cdhit-est -i $out_dir/output_fasta.fasta -o "$out_dir/output_fasta_clustered.fasta" -c 0.9 -T "$threads" -n 10 -d 0 -s 0.9 -g 0 -r 1 -mask N

if [ ! -d "$out_dir/cluster_intergenic_files" ]
then
	mkdir "$out_dir/cluster_intergenic_files"
fi

if [ ! -d "$out_dir/cluster_intergenic_alignment_files" ]
then
	mkdir "$out_dir/cluster_intergenic_alignment_files"
fi

cluster_alignment_creator.pl "$in_dir" "$out_dir"

readarray -t cluster_array < "$out_dir/clusters.txt"

for cluster in ${cluster_array[@]}
do
	seq_count=$(awk '/^>/{a++}END{print a}' "$out_dir/cluster_intergenic_files/${cluster}.fasta")
	
	if [ "$seq_count" -gt 1 ]
	then
		mafft --retree 2 --maxiterate 0 --adjustdirection "$out_dir/cluster_intergenic_files/${cluster}.fasta" > "$out_dir/cluster_intergenic_files/${cluster}_aligned_tmp.fasta"
		
		fasta_converter.pl "$out_dir/cluster_intergenic_files/${cluster}_aligned_tmp.fasta" "$out_dir/cluster_intergenic_files/${cluster}_aligned.fasta"
		
		cp "$out_dir/cluster_intergenic_files/${cluster}_aligned.fasta" "$out_dir/cluster_intergenic_alignment_files/${cluster}_aligned.fasta"
	else
		cp "$out_dir/cluster_intergenic_files/${cluster}.fasta" "$out_dir/cluster_intergenic_alignment_files/${cluster}_aligned.fasta"
	fi
done

cluster_presence_absence.pl "$in_dir" "$out_dir"

divergence_checker.pl "$roary_dir/pan_genome_sequences" "$out_dir" "roary_gene_divergences.csv"

divergence_checker.pl "$out_dir/cluster_intergenic_alignment_files" "$out_dir" "igry_IGR_divergences.csv"

roary_igry_combiner.pl "$out_dir" "$roary_dir"

if [ ! -d "$out_dir/switched_region_files" ]
then
	mkdir "$out_dir/switched_region_files"
fi

switched_region_creator.pl "$out_dir/roary_igry_combined.tab" "$out_dir/cluster_intergenic_files" "$out_dir"

if [ ! -d "$out_dir/switched_region_alignment_files" ]
then
	mkdir "$out_dir/switched_region_alignment_files"
fi

readarray -t switched_region_array < "$out_dir/switched_regions.txt"

for switched_region in ${switched_region_array[@]}
do
	mafft --retree 2 --maxiterate 0 --adjustdirection "$out_dir/switched_region_files/${switched_region}.fasta" > "$out_dir/switched_region_files/${switched_region}_aligned_tmp.fasta"
	
	fasta_converter.pl "$out_dir/switched_region_files/${switched_region}_aligned_tmp.fasta" "$out_dir/switched_region_files/${switched_region}_aligned.fasta"
	
	cp "$out_dir/switched_region_files/${switched_region}_aligned.fasta" "$out_dir/switched_region_alignment_files/${switched_region}_aligned.fasta"
done

fi

divergence_checker.pl "$out_dir/switched_region_alignment_files" "$out_dir" "switched_region_divergences.csv"

# Cleanup

#rm -r "$out_dir/cluster_intergenic_files"

